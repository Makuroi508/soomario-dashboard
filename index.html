<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Soomario Strategies – Bot Portfolio Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050711;
      color: #f5f5f5;
    }
    .wrap {
      max-width: 1080px;
      margin: 0 auto;
      padding: 20px;
    }
    h2 {
      margin: 0 0 6px;
      font-size: 20px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .subtitle {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 16px;
    }
    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .col-left {
      flex: 0 0 240px;
      max-width: 260px;
    }
    .col-right {
      flex: 1 1 320px;
      min-width: 260px;
    }
    .group-title {
      margin-top: 12px;
      margin-bottom: 4px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.75;
    }
    .bot-row {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      margin: 2px 0;
    }
    .bot-row small {
      font-size: 11px;
      opacity: 0.6;
    }
    .panel {
      background: rgba(255,255,255,0.02);
      border-radius: 10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    #equityChart {
      width: 100%;
      max-height: 320px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .stat-card {
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.06);
      padding: 8px 10px;
      font-size: 12px;
    }
    .stat-label {
      text-transform: uppercase;
      font-size: 10px;
      opacity: 0.7;
      letter-spacing: 0.08em;
      margin-bottom: 2px;
    }
    .stat-value {
      font-size: 14px;
      font-weight: 600;
    }
    .stat-sub {
      font-size: 11px;
      opacity: 0.7;
    }
    .invest-row {
      margin-top: 10px;
      font-size: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .invest-row input {
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
      border: 1px solid rgba(255,255,255,0.15);
      padding: 3px 6px;
      color: #fff;
      width: 110px;
    }
    .invest-output {
      opacity: 0.85;
      font-size: 12px;
    }
    .disclaimer {
      font-size: 11px;
      opacity: 0.65;
      margin-top: 8px;
      line-height: 1.4;
    }
    @media (max-width: 720px) {
      .col-left {
        flex: 1 1 100%;
        max-width: none;
      }
      .col-right {
        flex: 1 1 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Build Your Bot Mix</h2>
    <div class="subtitle">
      Backtests only. Portfolio is equally weighted across selected bots.  
      DCA engines are designed for spot / 1× exposure.
    </div>

    <div class="layout">
      <!-- LEFT: bot selection -->
      <div class="col-left panel">
        <div class="group-title">Reversal (10% SL, leverage-friendly)</div>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="HYPE_rev" checked />
          <span>HYPE 4h Reversal</span>
          <small>(HYPE_rev)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="LTC_rev" checked />
          <span>LTC 4h Reversal</span>
          <small>(LTC_rev)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="LINK_rev" />
          <span>LINK 4h Reversal</span>
          <small>(LINK_rev)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="CRV_rev" />
          <span>CRV 4h Reversal</span>
          <small>(CRV_rev)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="PUMP_rev" />
          <span>PUMP 4h Reversal</span>
          <small>(PUMP_rev)</small>
        </label>

        <div class="group-title">DCA Smoothers (Spot / 1× only)</div>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="SOL_DCA" />
          <span>SOL DCA Engine</span>
          <small>(SOL_DCA)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="LTC_DCA" />
          <span>LTC DCA Engine</span>
          <small>(LTC_DCA)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="BNB_DCA" />
          <span>BNB DCA Engine</span>
          <small>(BNB_DCA)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="ETH_DCA" />
          <span>ETH DCA Engine</span>
          <small>(ETH_DCA)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="ZEC_DCA" />
          <span>ZEC DCA Engine</span>
          <small>(ZEC_DCA)</small>
        </label>
      </div>

      <!-- RIGHT: chart + stats + calculator -->
      <div class="col-right">
        <div class="panel">
          <canvas id="equityChart"></canvas>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Return</div>
              <div class="stat-value" id="stat-total">–</div>
              <div class="stat-sub">Common backtest window</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Max Drawdown</div>
              <div class="stat-value" id="stat-dd">–</div>
              <div class="stat-sub">Closed-equity curve</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Annualized</div>
              <div class="stat-value" id="stat-ann">–</div>
              <div class="stat-sub">Backtest extrapolated</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Sharpe (approx)</div>
              <div class="stat-value" id="stat-sharpe">–</div>
              <div class="stat-sub">Daily returns, rf ≈ 0</div>
            </div>
          </div>

          <div class="invest-row">
            <label>
              Starting capital (USDT)
              <input id="start-capital" type="number" value="10000" min="0" step="100" />
            </label>
            <div class="invest-output" id="invest-output">–</div>
          </div>

          <div class="disclaimer">
            Portfolio = equal-weighted across selected bots. Results are backtests, not live PnL.  
            DCA engines assume spot / 1×; using leverage on DCA can lead to liquidation.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Bot data generated by build_botdata.py -->
  <script src="botData.js"></script>

  <script>
    // ---- helpers for working with botData ----
    if (typeof botData === "undefined") {
      console.error("botData is not defined – check that botData.js exists next to index.html");
    } else {
      // ensure each bot has sorted dates
      Object.keys(botData).forEach(name => {
        const bot = botData[name];
        const zipped = bot.dates.map((d, i) => ({ d, e: bot.equity[i] }));
        zipped.sort((a, b) => a.d.localeCompare(b.d));
        bot.dates = zipped.map(z => z.d);
        bot.equity = zipped.map(z => z.e);
      });
    }

    function getSelectedBots() {
      const selected = [];
      document.querySelectorAll(".bot-toggle").forEach(cb => {
        if (cb.checked && botData[cb.value]) selected.push(cb.value);
      });
      return selected;
    }

    // binary search: last index where date <= target
    function lastIndexLE(dates, target) {
      let lo = 0, hi = dates.length - 1, best = -1;
      while (lo <= hi) {
        const mid = (lo + hi) >> 1;
        if (dates[mid] <= target) {
          best = mid;
          lo = mid + 1;
        } else {
          hi = mid - 1;
        }
      }
      return best;
    }

    function buildPortfolioSeries(selectedBots) {
  if (!selectedBots.length) return { dates: [], equity: [] };

  // overlapping period: [max of starts, min of ends]
  let globalStart = null;
  let globalEnd = null;

  selectedBots.forEach(name => {
    const dates = botData[name].dates;
    const s = dates[0];
    const e = dates[dates.length - 1];
    if (!globalStart || s > globalStart) globalStart = s;
    if (!globalEnd || e < globalEnd) globalEnd = e;
  });

  if (!globalStart || !globalEnd || globalStart > globalEnd) {
    console.warn("No overlapping window for bots", selectedBots);
    return { dates: [], equity: [] };
  }

  const start = new Date(globalStart + "T00:00:00Z");
  const end = new Date(globalEnd + "T00:00:00Z");

  const dates = [];
  for (let d = new Date(start); d <= end; d.setUTCDate(d.getUTCDate() + 1)) {
    dates.push(d.toISOString().slice(0, 10));
  }

  const equity = dates.map(dateStr => {
    let sum = 0;
    selectedBots.forEach(name => {
      const bot = botData[name];
      const idx = lastIndexLE(bot.dates, dateStr);
      const eq = idx >= 0 ? bot.equity[idx] : 1.0;
      sum += eq;
    });
    return sum / selectedBots.length;
  });

  return { dates, equity };
}


    function computeStats(dates, equity) {
      if (!dates.length || !equity.length) {
        return { total: NaN, maxDD: NaN, ann: NaN, sharpe: NaN, days: 0 };
      }
      const first = equity[0];
      const last = equity[equity.length - 1];
      const total = last / first - 1;

      const startDate = new Date(dates[0] + "T00:00:00Z");
      const endDate = new Date(dates[dates.length - 1] + "T00:00:00Z");
      const days = Math.max(1, Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)));

      let peak = equity[0];
      let maxDD = 0;
      for (let i = 1; i < equity.length; i++) {
        if (equity[i] > peak) peak = equity[i];
        const dd = (equity[i] - peak) / peak;
        if (dd < maxDD) maxDD = dd;
      }

      const dailyReturns = [];
      for (let i = 1; i < equity.length; i++) {
        dailyReturns.push(equity[i] / equity[i - 1] - 1);
      }

      let sharpe = NaN;
      if (dailyReturns.length > 1) {
        const mean = dailyReturns.reduce((a, b) => a + b, 0) / dailyReturns.length;
        const variance = dailyReturns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) /
                         (dailyReturns.length - 1 || 1);
        const std = Math.sqrt(variance);
        if (std > 0) sharpe = (mean / std) * Math.sqrt(365);
      }

      const ann = Math.pow(1 + total, 365 / days) - 1;

      return { total, maxDD: maxDD, ann, sharpe, days };
    }

    let equityChart = null;

    function updateDashboard() {
      if (!equityChart || typeof botData === "undefined") return;

      const selected = getSelectedBots();
      const portfolio = buildPortfolioSeries(selected);
      const stats = computeStats(portfolio.dates, portfolio.equity);

      equityChart.data.labels = portfolio.dates;
      equityChart.data.datasets[0].data = portfolio.equity;
      equityChart.update();

      const fmtPct = x => isNaN(x) ? "–" : (x * 100).toFixed(1) + "%";
      const fmtNum = x => isNaN(x) ? "–" : x.toFixed(2);

      document.getElementById("stat-total").textContent = fmtPct(stats.total);
      document.getElementById("stat-dd").textContent = fmtPct(stats.maxDD);
      document.getElementById("stat-ann").textContent = fmtPct(stats.ann);
      document.getElementById("stat-sharpe").textContent = fmtNum(stats.sharpe);

      const capInput = document.getElementById("start-capital");
      let startCap = capInput ? parseFloat(capInput.value) : NaN;
      if (isNaN(startCap) || startCap <= 0) startCap = 0;

      let outText = "–";
      if (startCap > 0 && portfolio.equity.length) {
        const mult = portfolio.equity[portfolio.equity.length - 1];
        const finalVal = startCap * mult;
        const profit = finalVal - startCap;
        const sign = profit >= 0 ? "+" : "";
        outText = `${finalVal.toFixed(0)} USDT (P/L: ${sign}${profit.toFixed(0)})`;
      }
      document.getElementById("invest-output").textContent = outText;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const ctx = document.getElementById("equityChart").getContext("2d");
      equityChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Portfolio equity (normalized)",
            data: [],
            borderWidth: 2,
            borderColor: "rgba(255,255,255,0.9)",
            tension: 0.15,
            pointRadius: 0
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: { ticks: { maxTicksLimit: 8 } },
            y: {
              ticks: {
                callback: v => v.toFixed(2)
              }
            }
          }
        }
      });

      document.querySelectorAll(".bot-toggle").forEach(cb => {
        cb.addEventListener("change", updateDashboard);
      });

      const capInput = document.getElementById("start-capital");
      if (capInput) capInput.addEventListener("input", updateDashboard);

      updateDashboard();
    });
  </script>
</body>
</html>

