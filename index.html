<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Soomario Strategies ‚Äì Bot Portfolio Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a1438 0%, #2a1f4a 25%, #3d2f5c 50%, #2a1f4a 75%, #1a1438 100%);
      background-attachment: fixed;
      color: #e8d7c3;
      min-height: 100vh;
    }
    
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 50%, rgba(212, 165, 116, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 50%, rgba(244, 210, 145, 0.03) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    
    .wrap {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    h2 {
      margin: 0 0 10px;
      font-size: 2.5em;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
      font-weight: 800;
      background: linear-gradient(135deg, #d4a574 0%, #f4d291 50%, #c9973d 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 2px 2px 8px rgba(0,0,0,0.5);
    }
    
    .subtitle {
      font-size: 14px;
      color: #d4a574;
      margin-bottom: 30px;
      text-align: center;
      line-height: 1.6;
      font-weight: 500;
    }
    
    .layout {
      display: flex;
      flex-wrap: wrap;
      gap: 25px;
    }
    
    .col-left {
      flex: 0 0 280px;
      max-width: 300px;
    }
    
    .col-right {
      flex: 1 1 400px;
      min-width: 320px;
    }
    
    .group-title {
      margin-top: 20px;
      margin-bottom: 12px;
      font-size: 13px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #d4a574;
      border-bottom: 2px solid rgba(212, 165, 116, 0.3);
      padding-bottom: 6px;
    }
    
    .group-title:first-child {
      margin-top: 0;
    }
    
    .bot-row {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      margin: 8px 0;
      padding: 8px;
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .bot-row:hover {
      background: rgba(212, 165, 116, 0.1);
      transform: translateX(5px);
    }
    
    .bot-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #d4a574;
    }
    
    .bot-row span {
      color: #e8d7c3;
      font-weight: 500;
    }
    
    .bot-row small {
      font-size: 11px;
      color: #b8a896;
      margin-left: auto;
    }
    
    .panel {
      background: linear-gradient(135deg, rgba(61, 52, 112, 0.4) 0%, rgba(45, 37, 80, 0.4) 100%);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 25px;
      border: 2px solid rgba(212, 165, 116, 0.3);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }
    
    #equityChart {
      width: 100%;
      max-height: 350px;
      margin-bottom: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(61, 52, 112, 0.3) 0%, rgba(45, 37, 80, 0.3) 100%);
      border-radius: 12px;
      border: 2px solid rgba(212, 165, 116, 0.3);
      padding: 15px;
      text-align: center;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }
    
    .stat-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(212, 165, 116, 0.3);
      border-color: rgba(212, 165, 116, 0.6);
    }
    
    .stat-label {
      text-transform: uppercase;
      font-size: 11px;
      color: #d4a574;
      letter-spacing: 1px;
      margin-bottom: 8px;
      font-weight: 600;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: 800;
      background: linear-gradient(135deg, #d4a574 0%, #f4d291 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 5px;
    }
    
    .stat-sub {
      font-size: 10px;
      color: #b8a896;
      line-height: 1.3;
    }
    
    .invest-row {
      margin-top: 20px;
      font-size: 13px;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
      padding: 15px;
      background: rgba(26, 20, 56, 0.3);
      border-radius: 12px;
      border: 2px solid rgba(212, 165, 116, 0.2);
    }
    
    .invest-row label {
      color: #d4a574;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .invest-row input {
      background: rgba(26, 20, 56, 0.5);
      border-radius: 8px;
      border: 2px solid rgba(212, 165, 116, 0.3);
      padding: 8px 12px;
      color: #d4a574;
      width: 150px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    
    .invest-row input:focus {
      outline: none;
      border-color: rgba(212, 165, 116, 0.6);
      box-shadow: 0 0 15px rgba(212, 165, 116, 0.2);
    }
    
    .invest-output {
      color: #e8d7c3;
      font-size: 14px;
      font-weight: 600;
      padding: 8px 15px;
      background: rgba(212, 165, 116, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(212, 165, 116, 0.3);
    }
    
    .disclaimer {
      font-size: 12px;
      color: #ffb347;
      margin-top: 15px;
      line-height: 1.6;
      padding: 12px;
      background: rgba(255, 152, 0, 0.1);
      border: 2px solid rgba(255, 152, 0, 0.3);
      border-radius: 10px;
    }
    
    @media (max-width: 720px) {
      h2 {
        font-size: 1.8em;
      }
      .col-left {
        flex: 1 1 100%;
        max-width: none;
      }
      .col-right {
        flex: 1 1 100%;
      }
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>‚öôÔ∏è Build Your Bot Mix ‚öôÔ∏è</h2>
    <div class="subtitle">
      Backtests only. Portfolio is equally weighted across selected bots.<br>
      DCA engines are designed for spot / 1√ó exposure.
    </div>

    <div class="layout">
      <!-- LEFT: bot selection -->
      <div class="col-left panel">
        <div class="group-title">‚ö° Reversal (10% SL, leverage-friendly)</div>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="HYPE_rev" checked />
          <span>HYPE 4h Reversal</span>
          <small>(HYPE_rev)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="LTC_rev" checked />
          <span>LTC 4h Reversal</span>
          <small>(LTC_rev)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="LINK_rev" />
          <span>LINK 4h Reversal</span>
          <small>(LINK_rev)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="CRV_rev" />
          <span>CRV 4h Reversal</span>
          <small>(CRV_rev)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="PUMP_rev" />
          <span>PUMP 4h Reversal</span>
          <small>(PUMP_rev)</small>
        </label>

        <div class="group-title">üîÑ DCA Smoothers (Spot / 1√ó only)</div>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="SOL_DCA" />
          <span>SOL DCA Engine</span>
          <small>(SOL_DCA)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="LTC_DCA" />
          <span>LTC DCA Engine</span>
          <small>(LTC_DCA)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="BNB_DCA" />
          <span>BNB DCA Engine</span>
          <small>(BNB_DCA)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="ETH_DCA" />
          <span>ETH DCA Engine</span>
          <small>(ETH_DCA)</small>
        </label>

        <label class="bot-row">
          <input type="checkbox" class="bot-toggle" value="ZEC_DCA" />
          <span>ZEC DCA Engine</span>
          <small>(ZEC_DCA)</small>
        </label>
      </div>

      <!-- RIGHT: chart + stats + calculator -->
      <div class="col-right">
        <div class="panel">
          <canvas id="equityChart"></canvas>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-label">Total Return</div>
              <div class="stat-value" id="stat-total">‚Äî</div>
              <div class="stat-sub">Common backtest window</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Max Drawdown</div>
              <div class="stat-value" id="stat-dd">‚Äî</div>
              <div class="stat-sub">Closed-equity curve</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Annualized</div>
              <div class="stat-value" id="stat-ann">‚Äî</div>
              <div class="stat-sub">Backtest extrapolated</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Sharpe (approx)</div>
              <div class="stat-value" id="stat-sharpe">‚Äî</div>
              <div class="stat-sub">Daily returns, rf ‚âà 0</div>
            </div>
          </div>

          <div class="invest-row">
            <label>
              Starting capital (USDT)
              <input id="start-capital" type="number" value="10000" min="0" step="100" />
            </label>
            <div class="invest-output" id="invest-output">‚Äî</div>
          </div>

          <div class="disclaimer">
            ‚ö†Ô∏è Portfolio = equal-weighted across selected bots. Results are backtests, not live PnL.  
            DCA engines assume spot / 1√ó; using leverage on DCA can lead to liquidation.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Bot data generated by build_botdata.py -->
  <script src="botData.js"></script>

  <script>
    // ---- helpers for working with botData ----
    if (typeof botData === "undefined") {
      console.error("botData is not defined ‚Äì check that botData.js exists next to index.html");
    } else {
      // ensure each bot has sorted dates
      Object.keys(botData).forEach(name => {
        const bot = botData[name];
        const zipped = bot.dates.map((d, i) => ({ d, e: bot.equity[i] }));
        zipped.sort((a, b) => a.d.localeCompare(b.d));
        bot.dates = zipped.map(z => z.d);
        bot.equity = zipped.map(z => z.e);
      });
    }

    function getSelectedBots() {
      const selected = [];
      document.querySelectorAll(".bot-toggle").forEach(cb => {
        if (cb.checked && botData[cb.value]) selected.push(cb.value);
      });
      return selected;
    }

    // binary search: last index where date <= target
    function lastIndexLE(dates, target) {
      let lo = 0, hi = dates.length - 1, best = -1;
      while (lo <= hi) {
        const mid = (lo + hi) >> 1;
        if (dates[mid] <= target) {
          best = mid;
          lo = mid + 1;
        } else {
          hi = mid - 1;
        }
      }
      return best;
    }

    function buildPortfolioSeries(selectedBots) {
  if (!selectedBots.length) return { dates: [], equity: [] };

  // overlapping period: [max of starts, min of ends]
  let globalStart = null;
  let globalEnd = null;

  selectedBots.forEach(name => {
    const dates = botData[name].dates;
    const s = dates[0];
    const e = dates[dates.length - 1];
    if (!globalStart || s > globalStart) globalStart = s;
    if (!globalEnd || e < globalEnd) globalEnd = e;
  });

  if (!globalStart || !globalEnd || globalStart > globalEnd) {
    console.warn("No overlapping window for bots", selectedBots);
    return { dates: [], equity: [] };
  }

  const start = new Date(globalStart + "T00:00:00Z");
  const end = new Date(globalEnd + "T00:00:00Z");

  const dates = [];
  for (let d = new Date(start); d <= end; d.setUTCDate(d.getUTCDate() + 1)) {
    dates.push(d.toISOString().slice(0, 10));
  }

  const equity = dates.map(dateStr => {
    let sum = 0;
    selectedBots.forEach(name => {
      const bot = botData[name];
      const idx = lastIndexLE(bot.dates, dateStr);
      const eq = idx >= 0 ? bot.equity[idx] : 1.0;
      sum += eq;
    });
    return sum / selectedBots.length;
  });

  // Re-base so portfolio always starts at 1.0
  if (equity.length) {
    const base = equity[0];
    if (base !== 0) {
      for (let i = 0; i < equity.length; i++) {
        equity[i] = equity[i] / base;
      }
    }
  }

  return { dates, equity };
}



    function computeStats(dates, equity) {
      if (!dates.length || !equity.length) {
        return { total: NaN, maxDD: NaN, ann: NaN, sharpe: NaN, days: 0 };
      }
      const first = equity[0];
      const last = equity[equity.length - 1];
      const total = last / first - 1;

      const startDate = new Date(dates[0] + "T00:00:00Z");
      const endDate = new Date(dates[dates.length - 1] + "T00:00:00Z");
      const days = Math.max(1, Math.round((endDate - startDate) / (1000 * 60 * 60 * 24)));

      let peak = equity[0];
      let maxDD = 0;
      for (let i = 1; i < equity.length; i++) {
        if (equity[i] > peak) peak = equity[i];
        const dd = (equity[i] - peak) / peak;
        if (dd < maxDD) maxDD = dd;
      }

      const dailyReturns = [];
      for (let i = 1; i < equity.length; i++) {
        dailyReturns.push(equity[i] / equity[i - 1] - 1);
      }

      let sharpe = NaN;
      if (dailyReturns.length > 1) {
        const mean = dailyReturns.reduce((a, b) => a + b, 0) / dailyReturns.length;
        const variance = dailyReturns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) /
                         (dailyReturns.length - 1 || 1);
        const std = Math.sqrt(variance);
        if (std > 0) sharpe = (mean / std) * Math.sqrt(365);
      }

      const ann = Math.pow(1 + total, 365 / days) - 1;

      return { total, maxDD: maxDD, ann, sharpe, days };
    }

    let equityChart = null;

    function updateDashboard() {
      if (!equityChart || typeof botData === "undefined") return;

      const selected = getSelectedBots();
      const portfolio = buildPortfolioSeries(selected);
      const stats = computeStats(portfolio.dates, portfolio.equity);

      equityChart.data.labels = portfolio.dates;
      equityChart.data.datasets[0].data = portfolio.equity;
      equityChart.update();

      const fmtPct = x => isNaN(x) ? "‚Äî" : (x * 100).toFixed(1) + "%";
      const fmtNum = x => isNaN(x) ? "‚Äî" : x.toFixed(2);

      document.getElementById("stat-total").textContent = fmtPct(stats.total);
      document.getElementById("stat-dd").textContent = fmtPct(stats.maxDD);
      document.getElementById("stat-ann").textContent = fmtPct(stats.ann);
      document.getElementById("stat-sharpe").textContent = fmtNum(stats.sharpe);

      const capInput = document.getElementById("start-capital");
      let startCap = capInput ? parseFloat(capInput.value) : NaN;
      if (isNaN(startCap) || startCap <= 0) startCap = 0;

      let outText = "‚Äî";
      if (startCap > 0 && portfolio.equity.length) {
        const mult = portfolio.equity[portfolio.equity.length - 1];
        const finalVal = startCap * mult;
        const profit = finalVal - startCap;
        const sign = profit >= 0 ? "+" : "";
        outText = `${finalVal.toFixed(0)} USDT (P/L: ${sign}${profit.toFixed(0)})`;
      }
      document.getElementById("invest-output").textContent = outText;
    }

    document.addEventListener("DOMContentLoaded", () => {
      const ctx = document.getElementById("equityChart").getContext("2d");
      equityChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Portfolio equity (normalized)",
            data: [],
            borderWidth: 3,
            borderColor: "#d4a574",
            backgroundColor: "rgba(212, 165, 116, 0.1)",
            tension: 0.3,
            pointRadius: 0,
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "#f4d291",
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { 
              display: false 
            },
            tooltip: {
              backgroundColor: 'rgba(26, 20, 56, 0.9)',
              titleColor: '#d4a574',
              bodyColor: '#e8d7c3',
              borderColor: '#d4a574',
              borderWidth: 2
            }
          },
          scales: {
            x: { 
              ticks: { 
                maxTicksLimit: 8,
                color: '#d4a574'
              },
              grid: {
                color: 'rgba(212, 165, 116, 0.1)'
              }
            },
            y: {
              ticks: {
                callback: v => v.toFixed(2),
                color: '#d4a574'
              },
              grid: {
                color: 'rgba(212, 165, 116, 0.1)'
              }
            }
          }
        }
      });

      document.querySelectorAll(".bot-toggle").forEach(cb => {
        cb.addEventListener("change", updateDashboard);
      });

      const capInput = document.getElementById("start-capital");
      if (capInput) capInput.addEventListener("input", updateDashboard);

      updateDashboard();
    });
  </script>
</body>
</html>
